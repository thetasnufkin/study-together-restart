<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Study Together - みんなで集中</title>

  <link rel="stylesheet" href="style.css">
  <script defer src="/__/firebase/10.7.1/firebase-app-compat.js"></script>
  <script defer src="/__/firebase/10.7.1/firebase-auth-compat.js"></script>
  <script defer src="/__/firebase/10.7.1/firebase-database-compat.js"></script>
  <script defer src="/__/firebase/init.js"></script>
  <script defer src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script defer src="script.js?v=20260213-14"></script>
</head>
<body>
  <button class="settings-toggle" onclick="toggleSettings()" title="設定">設定</button>

  <div class="container">
    <div class="header">
      <h1>Study Together</h1>
      <p>一緒に集中、休憩で通話</p>
    </div>

    <div class="join-screen active" id="joinScreen">
      <div class="connection-status">
        <span class="connection-dot" id="connectionDot"></span>
        <span id="connectionText">Firebase に接続中...</span>
      </div>

      <div class="auth-card">
        <h3>参加モード</h3>
        <p id="authStatusText">ゲスト</p>
        <div class="auth-actions">
          <button class="btn btn-secondary" id="guestModeBtn" onclick="continueAsGuest()">ゲストで参加</button>
          <button class="btn btn-primary" id="googleSignInBtn" onclick="signInWithGoogle()">Googleでログイン</button>
          <button class="btn btn-secondary" id="googleSignOutBtn" onclick="signOutAccount()" style="display:none;">ログアウト</button>
        </div>
      </div>

      <div class="input-group">
        <label>ニックネーム</label>
        <input type="text" id="nickname" maxlength="10" placeholder="例: たろう">
      </div>
      <div class="input-group">
        <label>ルームID (作成時は入力不要)</label>
        <input type="text" id="roomId" maxlength="6" placeholder="例: ABC123" style="text-transform: uppercase;">
      </div>

      <button class="btn btn-primary" id="joinBtn" onclick="joinRoom()">参加する</button>
      <button class="btn btn-secondary" id="createBtn" onclick="createRoom()">新しいルームを作成</button>
    </div>

    <div class="main-screen" id="mainScreen">
      <div class="account-banner"><span id="accountBannerText">ゲスト参加中</span></div>
      <div class="top-actions"><button class="btn btn-secondary" onclick="loadMyProfile()">マイページ</button></div>

      <div class="task-card">
        <h3>今やるタスク</h3>
        <div class="task-form">
          <div class="template-chips">
            <button class="template-btn" onclick="chooseTemplate('趣味')">趣味</button>
            <button class="template-btn" onclick="chooseTemplate('研究')">研究</button>
            <button class="template-btn" onclick="chooseTemplate('就活')">就活</button>
            <button class="template-btn" onclick="chooseTemplate('読書')">読書</button>
            <button class="template-btn" onclick="chooseTemplate('運動')">運動</button>
            <button class="template-btn" onclick="chooseTemplate('資格勉強')">資格勉強</button>
          </div>
          <input type="text" id="taskInput" maxlength="60" placeholder="例: 数学の問題集 第3章 / 英単語 200語">
          <button class="btn btn-secondary" onclick="setCurrentTask()">更新</button>
        </div>
        <p class="task-hint">テンプレを選んでから自由入力もできます。</p>
      </div>

      <div class="timer-container">
        <span class="status-badge status-work" id="statusBadge">作業中</span>
        <div class="cycle-indicator" id="cycleIndicator"></div>
        <div class="progress-ring">
          <svg width="280" height="280">
            <circle class="progress-ring-circle" cx="140" cy="140" r="130"></circle>
            <circle class="progress-ring-progress work" id="progressCircle" cx="140" cy="140" r="130" stroke-dasharray="816.81" stroke-dashoffset="0"></circle>
          </svg>
          <div class="timer-inner">
            <div class="timer-display" id="timerDisplay">20:00</div>
            <div class="timer-label" id="timerLabel">作業タイム</div>
          </div>
        </div>
      </div>

      <div class="call-ui" id="callUI">
        <div class="call-status">
          <div class="call-icon">
            <svg viewBox="0 0 24 24"><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/></svg>
          </div>
          <span>休憩通話中</span>
        </div>
        <div class="audio-visualizer" id="audioVisualizer">
          <div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div>
          <div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div><div class="audio-bar"></div>
        </div>
        <div class="call-buttons"><button class="call-btn" id="muteBtn" onclick="toggleMute()">ミュート</button></div>
      </div>

      <div class="participants">
        <h3>参加者 (<span id="participantCount">0</span>人)</h3>
        <div class="participant-list" id="participantList"></div>
      </div>

      <div class="room-info">
        <div><small style="color: #8892b0;">ルームID</small><br><span class="room-code" id="roomCodeDisplay">-</span></div>
        <button class="copy-btn" onclick="copyRoomCode()">コピー</button>
      </div>

      <div class="controls">
        <div class="host-controls" id="hostControls">
          <button class="btn btn-primary" id="hostStartStopBtn" onclick="toggleHostTimer()">開始</button>
          <button class="btn btn-secondary" id="hostSkipBtn" onclick="skipToBreak()">休憩へスキップ</button>
        </div>
        <button class="btn btn-danger" onclick="leaveRoom()">退出</button>
      </div>
    </div>
  </div>

  <div class="profile-modal" id="profileModal">
    <div class="profile-modal-content">
      <div class="profile-modal-header">
        <h2 id="profileModalTitle">マイページ</h2>
        <button class="close-modal-btn" onclick="closeProfileModal()">閉じる</button>
      </div>
      <div class="profile-date-nav">
        <button class="date-nav-btn" id="profilePrevDateBtn" onclick="moveProfileDate(-1)">◀</button>
        <div class="profile-date-label" id="profileDateLabel">--</div>
        <button class="date-nav-btn" id="profileNextDateBtn" onclick="moveProfileDate(1)">▶</button>
      </div>
      <div class="profile-summary" id="profileSummary">プロフィール未選択</div>
      <div class="profile-history" id="profileHistory"></div>
    </div>
  </div>

  <div class="settings-modal" id="settingsModal">
    <div class="settings-content">
      <h2>タイマー設定</h2>
      <div class="setting-row">
        <label>作業時間 (分)</label>
        <input type="number" id="workMinutes" value="20" min="1" max="60">
      </div>
      <div class="setting-row">
        <label>休憩時間 (分)</label>
        <input type="number" id="breakMinutes" value="5" min="1" max="30">
      </div>
      <button class="btn btn-primary close-settings" onclick="saveSettings()">保存して閉じる</button>
    </div>
  </div>

  <div class="notification" id="notification"></div>
</body>
</html>
